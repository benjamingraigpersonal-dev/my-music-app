<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: var(--tg-theme-bg-color, #0f0f0f);
            --text: var(--tg-theme-text-color, #fff);
            --hint: var(--tg-theme-hint-color, #777);
            --accent: var(--tg-theme-button-color, #0088cc);
        }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; padding: 15px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .edit-btn { background: none; border: 1px solid var(--accent); color: var(--accent); padding: 6px 12px; border-radius: 8px; font-size: 12px; }
        .edit-btn.active { background: #ff3b30; border-color: #ff3b30; color: white; }
        input { width: 100%; padding: 12px; border-radius: 12px; border: none; background: rgba(128,128,128,0.1); color: var(--text); box-sizing: border-box; margin-bottom: 15px; outline: none; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .card { background: rgba(128,128,128,0.05); border-radius: 16px; padding: 10px; position: relative; text-align: center; border: 1px solid rgba(128,128,128,0.1); transition: transform 0.1s; }
        .card:active { transform: scale(0.96); }
        .cover { width: 100%; aspect-ratio: 1; background: linear-gradient(135deg, var(--accent), #000); border-radius: 12px; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; font-size: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .title { font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .del-badge { position: absolute; top: -5px; right: -5px; background: #ff3b30; color: white; border-radius: 50%; width: 24px; height: 24px; display: none; align-items: center; justify-content: center; font-size: 18px; font-weight: bold; border: 2px solid var(--bg); }
        .edit-mode .del-badge { display: flex; }
        .edit-mode .card { animation: shake 0.3s infinite; }
        @keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(1deg); } 75% { transform: rotate(-1deg); } 100% { transform: rotate(0deg); } }
    </style>
</head>
<body>
    <div class="header">
        <h2 style="margin:0;">Music Player</h2>
        <button id="editBtn" class="edit-btn" onclick="toggleEdit()">ÐŸÑ€Ð°Ð²Ð¸Ñ‚ÑŒ</button>
    </div>
    <input type="text" id="search" placeholder="ÐŸÐ¾Ð¸ÑÐº Ð¿Ð¾ Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐµ..." oninput="doSearch()">
    <div id="content"></div>

    <script>
        let tg = window.Telegram.WebApp;
        let isEdit = false;
        tg.expand();
        tg.ready();

        const dataStr = new URLSearchParams(window.location.search).get('data');
        const content = document.getElementById('content');

        function toggleEdit() {
            isEdit = !isEdit;
            document.body.classList.toggle('edit-mode', isEdit);
            document.getElementById('editBtn').innerText = isEdit ? 'Ð“Ð¾Ñ‚Ð¾Ð²Ð¾' : 'ÐŸÑ€Ð°Ð²Ð¸Ñ‚ÑŒ';
            document.getElementById('editBtn').classList.toggle('active', isEdit);
        }

        if (dataStr) {
            const musicData = JSON.parse(decodeURIComponent(dataStr));
            for (const folder in musicData) {
                const folderDiv = document.createElement('div');
                folderDiv.className = 'folder-group';
                folderDiv.innerHTML = `<div style="color:var(--hint); font-size:10px; text-transform:uppercase; margin:20px 0 10px 5px;">${folder}</div>`;
                
                const grid = document.createElement('div');
                grid.className = 'grid';
                
                musicData[folder].forEach(t => {
                    const card = document.createElement('div');
                    card.className = 'card track';
                    card.dataset.name = t.name.toLowerCase();
                    card.innerHTML = `<div class="del-badge">âˆ’</div><div class="cover">ðŸŽ§</div><div class="title">${t.name}</div>`;
                    card.onclick = () => {
                        const action = isEdit ? "delete" : "play";
                        tg.sendData(JSON.stringify({action: action, folder: folder, file_id: t.file_id, title: t.name}));
                        tg.close();
                    };
                    grid.appendChild(card);
                });
                folderDiv.appendChild(grid);
                content.appendChild(folderDiv);
            }
        }

        function doSearch() {
            const q = document.getElementById('search').value.toLowerCase();
            document.querySelectorAll('.track').forEach(t => {
                t.style.display = t.dataset.name.includes(q) ? 'block' : 'none';
            });
            document.querySelectorAll('.folder-group').forEach(g => {
                const visible = g.querySelectorAll('.track[style="display: block;"]').length > 0;
                g.style.display = visible || q === "" ? 'block' : 'none';
            });
        }
    </script>
</body>
</html>

