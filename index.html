<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aura Music v2.0</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg: #0b0b0b; --accent: #1DB954; --panel: #181818; --text: #ffffff; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; margin: 0; padding: 15px; padding-bottom: 120px; }
        
        .search-box { display: flex; gap: 10px; margin-bottom: 20px; position: sticky; top: 0; background: var(--bg); padding: 10px 0; z-index: 10; }
        input { flex: 1; padding: 12px; border-radius: 10px; border: 1px solid #333; background: var(--panel); color: white; outline: none; }
        button.search-btn { background: var(--accent); color: black; border: none; padding: 10px 15px; border-radius: 10px; font-weight: bold; }

        .section-title { color: #888; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; margin: 20px 0 10px; }
        
        .track-card { display: flex; align-items: center; gap: 12px; background: var(--panel); padding: 10px; border-radius: 12px; margin-bottom: 8px; }
        .track-img { width: 48px; height: 48px; border-radius: 6px; object-fit: cover; }
        .track-info { flex: 1; overflow: hidden; }
        .track-name { font-weight: 600; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .add-btn { background: none; border: 1px solid var(--accent); color: var(--accent); width: 32px; height: 32px; border-radius: 50%; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; }

        .player-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #121212; padding: 15px; border-top: 1px solid var(--accent); display: none; box-shadow: 0 -5px 20px rgba(0,0,0,0.5); }
        audio { width: 100%; height: 35px; margin-top: 8px; filter: invert(100%) hue-rotate(180deg) brightness(1.5); }
    </style>
</head>
<body>

    <div class="search-box">
        <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ —Ç—Ä–µ–∫–æ–≤ –∏–ª–∏ –∞—Ä—Ç–∏—Å—Ç–æ–≤...">
        <button class="search-btn" onclick="performSearch()">–ù–∞–π—Ç–∏</button>
    </div>

    <div id="searchResults"></div>

    <div class="section-title">–ú–æ–∏ –ü–ª–µ–π–ª–∏—Å—Ç—ã</div>
    <div id="userPlaylist"></div>

    <div class="player-bar" id="playerBar">
        <div id="currentTrackTitle" style="font-size: 0.8rem; font-weight: bold; color: var(--accent);"></div>
        <audio id="audioPlayer" controls></audio>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        // !!! –í–ê–ñ–ù–û: –í–°–¢–ê–í–¨ –°–Æ–î–ê –°–°–´–õ–ö–£ –ò–ó LOCAL TUNNEL !!!
        const API_URL = "https://brown-bags-pick.loca.lt"; 
        const userId = tg.initDataUnsafe.user?.id || 0;

        async function performSearch() {
            const query = document.getElementById('searchInput').value;
            if (!query) return;
            
            const btn = document.querySelector('.search-btn');
            btn.innerText = "...";

            try {
                const response = await fetch(`${API_URL}/search?q=${encodeURIComponent(query)}`);
                const tracks = await response.json();
                
                const container = document.getElementById('searchResults');
                container.innerHTML = '<div class="section-title">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞</div>';
                
                tracks.forEach(track => {
                    container.innerHTML += `
                        <div class="track-card">
                            <img src="${track.thumb || 'https://via.placeholder.com/50'}" class="track-img">
                            <div class="track-info" onclick="startPlayback('${track.url}', '${track.title.replace(/'/g, "")}')">
                                <div class="track-name">${track.title}</div>
                            </div>
                            <button class="add-btn" onclick="saveToPlaylist('${track.title.replace(/'/g, "")}', '${track.url}')">+</button>
                        </div>`;
                });
            } catch (err) {
                alert("–û—à–∏–±–∫–∞: –°–µ—Ä–≤–µ—Ä Aura –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ LocalTunnel.");
            } finally {
                btn.innerText = "–ù–∞–π—Ç–∏";
            }
        }

        async function saveToPlaylist(title, url) {
            try {
                await fetch(`${API_URL}/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, title: title, url: url })
                });
                loadPlaylist();
            } catch (e) { console.error(e); }
        }

        async function loadPlaylist() {
            try {
                const response = await fetch(`${API_URL}/get?user_id=${userId}`);
                const tracks = await response.json();
                const container = document.getElementById('userPlaylist');
                container.innerHTML = tracks.map(t => `
                    <div class="track-card" onclick="startPlayback('${t.url}', '${t.title.replace(/'/g, "")}')">
                        <div class="track-info">
                            <div class="track-name">üéµ ${t.title}</div>
                        </div>
                    </div>
                `).join('');
            } catch (e) { console.error(e); }
        }

        function startPlayback(url, title) {
            const bar = document.getElementById('playerBar');
            const audio = document.getElementById('audioPlayer');
            document.getElementById('currentTrackTitle').innerText = "‚ñ∂ " + title;
            bar.style.display = 'block';
            audio.src = url;
            audio.play();
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–ª–µ–π–ª–∏—Å—Ç –ø—Ä–∏ –≤—Ö–æ–¥–µ
        loadPlaylist();
    </script>
</body>
</html>

